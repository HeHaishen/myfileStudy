define(["exports","./Cartesian2-fe435665","./when-23b1aa97","./Math-e9e583a9","./Transforms-21fa56f0"],function(a,S,m,O,x){"use strict";var P={};function i(a,t,r){var e=a+t;return O.CrystalMath.sign(a)!==O.CrystalMath.sign(t)&&Math.abs(e/Math.max(Math.abs(a),Math.abs(t)))<r?0:e}P.computeDiscriminant=function(a,t,r){return t*t-4*a*r},P.computeRealRoots=function(a,t,r){if(0===a)return 0===t?[]:[-r/t];if(0===t){if(0===r)return[0,0];var e=Math.abs(r),n=Math.abs(a);if(e<n&&e/n<O.CrystalMath.EPSILON14)return[0,0];if(n<e&&n/e<O.CrystalMath.EPSILON14)return[];if((n=-r/a)<0)return[];e=Math.sqrt(n);return[-e,e]}if(0===r)return(n=-t/a)<0?[n,0]:[0,n];n=i(t*t,-(4*a*r),O.CrystalMath.EPSILON14);if(n<0)return[];n=-.5*i(t,O.CrystalMath.sign(t)*Math.sqrt(n),O.CrystalMath.EPSILON14);return 0<t?[n/a,r/n]:[r/n,n/a]};var g={};function s(a,t,r,e){var n=a,i=t/3,s=r/3,o=e,u=n*s,l=i*o,C=i*i,c=s*s,h=n*s-C,a=n*o-i*s,t=i*o-c,r=4*h*t-a*a;if(r<0){var e=u*c<=C*l?-2*i*(d=h)+(f=n)*a:-(f=o)*a+2*s*(d=t),M=-(e<0?-1:1)*Math.abs(f)*Math.sqrt(-r),f=(m=M-e)/2,f=f<0?-Math.pow(-f,1/3):Math.pow(f,1/3),M=m===M?-f:-d/f,M=d<=0?f+M:-e/(f*f+M*M+d);return u*c<=C*l?[(M-i)/n]:[-o/(M+s)]}var d=h,u=-2*i*h+n*a,c=t,C=-o*a+2*s*t,l=Math.sqrt(r),h=Math.sqrt(3)/2,a=Math.abs(Math.atan2(n*l,-u)/3);M=2*Math.sqrt(-d);t=Math.cos(a);m=M*t;var r=M*(-t/2-h*Math.sin(a)),u=2*i<m+r?m-i:r-i,d=n,n=u/d,a=Math.abs(Math.atan2(o*l,-C)/3),o=-o,a=(m=(M=2*Math.sqrt(-c))*(t=Math.cos(a)))+(r=M*(-t/2-h*Math.sin(a)))<2*s?m+s:r+s,m=o/a,r=-u*a-d*o,a=(s*r-i*(u*o))/(-i*r+s*(d*a));return n<=a?n<=m?a<=m?[n,a,m]:[n,m,a]:[m,n,a]:n<=m?[a,n,m]:a<=m?[a,m,n]:[m,a,n]}g.computeDiscriminant=function(a,t,r,e){var n=t*t,i=r*r;return 18*a*t*r*e+n*i-27*(a*a)*(e*e)-4*(a*i*r+n*t*e)},g.computeRealRoots=function(a,t,r,e){var n;if(0===a)return P.computeRealRoots(t,r,e);if(0!==t)return 0===r?0===e?(i=-t/a)<0?[i,0,0]:[0,0,i]:s(a,t,0,e):0===e?0===(n=P.computeRealRoots(a,t,r)).length?[0]:n[1]<=0?[n[0],n[1],0]:0<=n[0]?[0,n[0],n[1]]:[n[0],0,n[1]]:s(a,t,r,e);if(0!==r)return 0===e?0===(n=P.computeRealRoots(a,0,r)).Length?[0]:[n[0],0,n[1]]:s(a,0,r,e);if(0===e)return[0,0,0];var i=(i=-e/a)<0?-Math.pow(-i,1/3):Math.pow(i,1/3);return[i,i,i]};var N={};function l(a,t,r,e){var n=a*a,i=t-3*n/8,s=r-t*a/2+n*a/8,e=e-r*a/4+t*n/16-3*n*n/256,r=g.computeRealRoots(1,2*i,i*i-4*e,-s*s);if(0<r.length){t=-a/4,n=r[r.length-1];if(Math.abs(n)<O.CrystalMath.EPSILON14){a=P.computeRealRoots(1,i,e);if(2===a.length){var r=a[0],o=a[1];if(0<=r&&0<=o){e=Math.sqrt(r),a=Math.sqrt(o);return[t-a,t-e,t+e,t+a]}if(0<=r&&o<0)return[t-(u=Math.sqrt(r)),t+u];if(r<0&&0<=o)return[t-(u=Math.sqrt(o)),t+u]}return[]}if(0<n){var o=Math.sqrt(n),u=(i+n-s/o)/2,s=(i+n+s/o)/2,u=P.computeRealRoots(1,o,u),s=P.computeRealRoots(1,-o,s);return 0!==u.length?(u[0]+=t,u[1]+=t,0!==s.length?(s[0]+=t,s[1]+=t,u[1]<=s[0]?[u[0],u[1],s[0],s[1]]:s[1]<=u[0]?[s[0],s[1],u[0],u[1]]:u[0]>=s[0]&&u[1]<=s[1]?[s[0],u[0],u[1],s[1]]:s[0]>=u[0]&&s[1]<=u[1]?[u[0],s[0],s[1],u[1]]:u[0]>s[0]&&u[0]<s[1]?[s[0],u[0],s[1],u[1]]:[u[0],s[0],u[1],s[1]]):u):0!==s.length?(s[0]+=t,s[1]+=t,s):[]}}return[]}function C(a,t,r,e){var n=a*a,i=-2*t,s=r*a+t*t-4*e,o=n*e-r*t*a+r*r,u=g.computeRealRoots(1,i,s,o);if(0<u.length){var l,C,c,h,M=u[0],i=t-M,s=i*i,o=a/2,u=i/2,t=s-4*e,i=s+4*Math.abs(e),s=n-4*M,n=n+4*Math.abs(M);C=M<0||t*n<s*i?(l=(s=Math.sqrt(s))/2,0===s?0:(a*u-r)/s):(l=0===(C=Math.sqrt(t))?0:(a*u-r)/C,C/2),0==o&&0===l?h=c=0:O.CrystalMath.sign(o)===O.CrystalMath.sign(l)?h=M/(c=o+l):c=M/(h=o-l),0==u&&0===C?d=f=0:O.CrystalMath.sign(u)===O.CrystalMath.sign(C)?d=e/(f=u+C):f=e/(d=u-C);var f=P.computeRealRoots(1,c,f),d=P.computeRealRoots(1,h,d);if(0!==f.length)return 0!==d.length?f[1]<=d[0]?[f[0],f[1],d[0],d[1]]:d[1]<=f[0]?[d[0],d[1],f[0],f[1]]:f[0]>=d[0]&&f[1]<=d[1]?[d[0],f[0],f[1],d[1]]:d[0]>=f[0]&&d[1]<=f[1]?[f[0],d[0],d[1],f[1]]:f[0]>d[0]&&f[0]<d[1]?[d[0],f[0],d[1],f[1]]:[f[0],d[0],f[1],d[1]]:f;if(0!==d.length)return d}return[]}function r(a,t){t=S.Cartesian3.clone(m.defaultValue(t,S.Cartesian3.ZERO)),S.Cartesian3.equals(t,S.Cartesian3.ZERO)||S.Cartesian3.normalize(t,t),this.origin=S.Cartesian3.clone(m.defaultValue(a,S.Cartesian3.ZERO)),this.direction=t}N.computeDiscriminant=function(a,t,r,e,n){var i=a*a,s=t*t,o=s*t,u=r*r,l=u*r,C=e*e,c=C*e,h=n*n;return s*u*C-4*o*c-4*a*l*C+18*a*t*r*c-27*i*C*C+256*(i*a)*(h*n)+n*(18*o*r*e-4*s*l+16*a*u*u-80*a*t*u*e-6*a*s*C+144*i*r*C)+h*(144*a*s*r-27*s*s-128*i*u-192*i*t*e)},N.computeRealRoots=function(a,t,r,e,n){if(Math.abs(a)<O.CrystalMath.EPSILON15)return g.computeRealRoots(t,r,e,n);var i=t/a,s=r/a,o=e/a,u=n/a,a=i<0?1:0;switch(a+=s<0?a+1:a,a+=o<0?a+1:a,a+=u<0?a+1:a){case 0:return l(i,s,o,u);case 1:case 2:return C(i,s,o,u);case 3:case 4:return l(i,s,o,u);case 5:return C(i,s,o,u);case 6:case 7:return l(i,s,o,u);case 8:return C(i,s,o,u);case 9:case 10:return l(i,s,o,u);case 11:return C(i,s,o,u);case 12:case 13:case 14:case 15:return l(i,s,o,u);default:return}},r.clone=function(a,t){if(m.defined(a))return m.defined(t)?(t.origin=S.Cartesian3.clone(a.origin),t.direction=S.Cartesian3.clone(a.direction),t):new r(a.origin,a.direction)},r.getPoint=function(a,t,r){return m.defined(r)||(r=new S.Cartesian3),r=S.Cartesian3.multiplyByScalar(a.direction,t,r),S.Cartesian3.add(a.origin,r,r)};var c={rayPlane:function(a,t,r){m.defined(r)||(r=new S.Cartesian3);var e=a.origin,n=a.direction,i=t.normal,a=S.Cartesian3.dot(i,n);if(!(Math.abs(a)<O.CrystalMath.EPSILON15)){a=(-t.distance-S.Cartesian3.dot(i,e))/a;if(!(a<0))return r=S.Cartesian3.multiplyByScalar(n,a,r),S.Cartesian3.add(e,r,r)}}},M=new S.Cartesian3,f=new S.Cartesian3,d=new S.Cartesian3,p=new S.Cartesian3,y=new S.Cartesian3;c.rayTriangleParametric=function(a,t,r,e,n){n=m.defaultValue(n,!1);var i,s,o,u=a.origin,l=a.direction,C=S.Cartesian3.subtract(r,t,M),a=S.Cartesian3.subtract(e,t,f),r=S.Cartesian3.cross(l,a,d),e=S.Cartesian3.dot(C,r);if(n){if(e<O.CrystalMath.EPSILON6)return;if(h=S.Cartesian3.subtract(u,t,p),(c=S.Cartesian3.dot(h,r))<0||e<c)return;if(i=S.Cartesian3.cross(h,C,y),(s=S.Cartesian3.dot(l,i))<0||e<c+s)return;o=S.Cartesian3.dot(a,i)/e}else{if(Math.abs(e)<O.CrystalMath.EPSILON6)return;var c,e=1/e,h=S.Cartesian3.subtract(u,t,p);if((c=S.Cartesian3.dot(h,r)*e)<0||1<c)return;if(i=S.Cartesian3.cross(h,C,y),(s=S.Cartesian3.dot(l,i)*e)<0||1<c+s)return;o=S.Cartesian3.dot(a,i)*e}return o},c.rayTriangle=function(a,t,r,e,n,i){n=c.rayTriangleParametric(a,t,r,e,n);if(m.defined(n)&&!(n<0))return m.defined(i)||(i=new S.Cartesian3),S.Cartesian3.multiplyByScalar(a.direction,n,i),S.Cartesian3.add(a.origin,i,i)};var u=new r;c.lineSegmentTriangle=function(a,t,r,e,n,i,s){var o=u;S.Cartesian3.clone(a,o.origin),S.Cartesian3.subtract(t,a,o.direction),S.Cartesian3.normalize(o.direction,o.direction);i=c.rayTriangleParametric(o,r,e,n,i);if(!(!m.defined(i)||i<0||i>S.Cartesian3.distance(a,t)))return m.defined(s)||(s=new S.Cartesian3),S.Cartesian3.multiplyByScalar(o.direction,i,s),S.Cartesian3.add(o.origin,s,s)};var o={root0:0,root1:0};function h(a,t,r){m.defined(r)||(r=new x.Interval);var e=a.origin,n=a.direction,a=t.center,t=t.radius*t.radius,a=S.Cartesian3.subtract(e,a,d),t=function(a,t,r,e){if(!((i=t*t-4*a*r)<0)){if(0<i){var n=1/(2*a),r=Math.sqrt(i),i=(-t+r)*n,n=(-t-r)*n;return i<n?(e.root0=i,e.root1=n):(e.root0=n,e.root1=i),e}a=-t/(2*a);if(0!=a)return e.root0=e.root1=a,e}}(S.Cartesian3.dot(n,n),2*S.Cartesian3.dot(n,a),S.Cartesian3.magnitudeSquared(a)-t,o);if(m.defined(t))return r.start=t.root0,r.stop=t.root1,r}c.raySphere=function(a,t,r){if(r=h(a,t,r),m.defined(r)&&!(r.stop<0))return r.start=Math.max(r.start,0),r};var v=new r;c.lineSegmentSphere=function(a,t,r,e){var n=v;S.Cartesian3.clone(a,n.origin);t=S.Cartesian3.subtract(t,a,n.direction),a=S.Cartesian3.magnitude(t);if(S.Cartesian3.normalize(t,t),e=h(n,r,e),!(!m.defined(e)||e.stop<0||e.start>a))return e.start=Math.max(e.start,0),e.stop=Math.min(e.stop,a),e};var w=new S.Cartesian3,R=new S.Cartesian3;function b(a,t,r){var e=a+t;return O.CrystalMath.sign(a)!==O.CrystalMath.sign(t)&&Math.abs(e/Math.max(Math.abs(a),Math.abs(t)))<r?0:e}c.rayEllipsoid=function(a,t){var r=t.oneOverRadii,e=S.Cartesian3.multiplyComponents(r,a.origin,w),t=S.Cartesian3.multiplyComponents(r,a.direction,R),r=S.Cartesian3.magnitudeSquared(e),a=S.Cartesian3.dot(e,t);if(1<r){if(0<=a)return;var n,i,e=a*a,s=r-1;if(e<(i=(n=S.Cartesian3.magnitudeSquared(t))*s))return;if(i<e){var o,u=a*a-i,l=(o=-a+Math.sqrt(u))/n,e=s/o;return l<e?new x.Interval(l,e):{start:e,stop:l}}l=Math.sqrt(s/n);return new x.Interval(l,l)}return r<1?(s=r-1,u=a*a-(i=(n=S.Cartesian3.magnitudeSquared(t))*s),o=-a+Math.sqrt(u),new x.Interval(0,o/n)):a<0?(n=S.Cartesian3.magnitudeSquared(t),new x.Interval(0,-a/n)):void 0};var q=new S.Cartesian3,L=new S.Cartesian3,I=new S.Cartesian3,E=new S.Cartesian3,z=new S.Cartesian3,T=new x.Matrix3,U=new x.Matrix3,W=new x.Matrix3,B=new x.Matrix3,V=new x.Matrix3,Z=new x.Matrix3,A=new x.Matrix3,D=new S.Cartesian3,F=new S.Cartesian3,G=new S.Cartographic;c.grazingAltitudeLocation=function(a,t){var r=a.origin,e=a.direction;if(!S.Cartesian3.equals(r,S.Cartesian3.ZERO)){var n=t.geodeticSurfaceNormal(r,q);if(0<=S.Cartesian3.dot(e,n))return r}var i=m.defined(this.rayEllipsoid(a,t)),s=t.transformPositionToScaledSpace(e,q),n=S.Cartesian3.normalize(s,s),a=S.Cartesian3.mostOrthogonalAxis(s,E),s=S.Cartesian3.normalize(S.Cartesian3.cross(a,n,L),L),a=S.Cartesian3.normalize(S.Cartesian3.cross(n,s,I),I),o=T;o[0]=n.x,o[1]=n.y,o[2]=n.z,o[3]=s.x,o[4]=s.y,o[5]=s.z,o[6]=a.x,o[7]=a.y,o[8]=a.z;var n=x.Matrix3.transpose(o,U),u=x.Matrix3.fromScale(t.radii,W),s=x.Matrix3.fromScale(t.oneOverRadii,B),a=V;a[0]=0,a[1]=-e.z,a[2]=e.y,a[3]=e.z,a[4]=0,a[5]=-e.x,a[6]=-e.y,a[7]=e.x,a[8]=0;var s=x.Matrix3.multiply(x.Matrix3.multiply(n,s,Z),a,Z),a=x.Matrix3.multiply(x.Matrix3.multiply(s,u,A),o,A),s=x.Matrix3.multiplyByVector(s,r,z),l=function(a,t,r,e,n){var i=e*e,s=n*n,o=(a[x.Matrix3.COLUMN1ROW1]-a[x.Matrix3.COLUMN2ROW2])*s,u=n*(e*b(a[x.Matrix3.COLUMN1ROW0],a[x.Matrix3.COLUMN0ROW1],O.CrystalMath.EPSILON15)+t.y),l=a[x.Matrix3.COLUMN0ROW0]*i+a[x.Matrix3.COLUMN2ROW2]*s+e*t.x+r,C=s*b(a[x.Matrix3.COLUMN2ROW1],a[x.Matrix3.COLUMN1ROW2],O.CrystalMath.EPSILON15),c=n*(e*b(a[x.Matrix3.COLUMN2ROW0],a[x.Matrix3.COLUMN0ROW2])+t.z),h=[];if(0==c&&0==C){if(0===(g=P.computeRealRoots(o,u,l)).length)return h;var M=g[0],f=Math.sqrt(Math.max(1-M*M,0));return h.push(new S.Cartesian3(e,n*M,n*-f)),h.push(new S.Cartesian3(e,n*M,n*f)),2===g.length&&(d=g[1],m=Math.sqrt(Math.max(1-d*d,0)),h.push(new S.Cartesian3(e,n*d,n*-m)),h.push(new S.Cartesian3(e,n*d,n*m))),h}var d=o*o+(M=C*C),m=2*(u*o+(f=c*C)),M=2*l*o+u*u-M+(t=c*c),f=2*(l*u-f),t=l*l-t;if(0==d&&0==m&&0==M&&0==f)return h;var g,p=(g=N.computeRealRoots(d,m,M,f,t)).length;if(0===p)return h;for(var y=0;y<p;++y){var v=g[y],w=v*v,R=Math.max(1-w,0),R=Math.sqrt(R),w=O.CrystalMath.sign(o)===O.CrystalMath.sign(l)?b(o*w+l,u*v,O.CrystalMath.EPSILON12):O.CrystalMath.sign(l)===O.CrystalMath.sign(u*v)?b(o*w,u*v+l,O.CrystalMath.EPSILON12):b(o*w+u*v,l,O.CrystalMath.EPSILON12),w=w*b(C*v,c,O.CrystalMath.EPSILON15);w<0?h.push(new S.Cartesian3(e,n*v,n*R)):0<w?h.push(new S.Cartesian3(e,n*v,n*-R)):0!==R?(h.push(new S.Cartesian3(e,n*v,n*-R)),h.push(new S.Cartesian3(e,n*v,n*R)),++y):h.push(new S.Cartesian3(e,n*v,n*R))}return h}(a,S.Cartesian3.negate(s,q),0,0,1),C=l.length;if(0<C){for(var c=S.Cartesian3.clone(S.Cartesian3.ZERO,F),h=Number.NEGATIVE_INFINITY,M=0;M<C;++M){var f=x.Matrix3.multiplyByVector(u,x.Matrix3.multiplyByVector(o,l[M],D),D),d=S.Cartesian3.normalize(S.Cartesian3.subtract(f,r,E),E),d=S.Cartesian3.dot(d,e);h<d&&(h=d,c=S.Cartesian3.clone(f,c))}a=t.cartesianToCartographic(c,G),h=O.CrystalMath.clamp(h,0,1),s=S.Cartesian3.magnitude(S.Cartesian3.subtract(c,r,E))*Math.sqrt(1-h*h);return s=i?-s:s,a.height=s,t.cartographicToCartesian(a,new S.Cartesian3)}};var Y=new S.Cartesian3;c.lineSegmentPlane=function(a,t,r,e){m.defined(e)||(e=new S.Cartesian3);var n=S.Cartesian3.subtract(t,a,Y),i=r.normal,t=S.Cartesian3.dot(i,n);if(!(Math.abs(t)<O.CrystalMath.EPSILON6)){i=S.Cartesian3.dot(i,a),t=-(r.distance+i)/t;if(!(t<0||1<t))return S.Cartesian3.multiplyByScalar(n,t,e),S.Cartesian3.add(a,e,e),e}},c.trianglePlaneIntersection=function(a,t,r,e){var n,i,s=e.normal,o=e.distance,u=S.Cartesian3.dot(s,a)+o<0,l=S.Cartesian3.dot(s,t)+o<0,s=S.Cartesian3.dot(s,r)+o<0,o=0;if(o+=u?1:0,o+=l?1:0,1!=(o+=s?1:0)&&2!=o||(n=new S.Cartesian3,i=new S.Cartesian3),1==o){if(u)return c.lineSegmentPlane(a,t,e,n),c.lineSegmentPlane(a,r,e,i),{positions:[a,t,r,n,i],indices:[0,3,4,1,2,4,1,4,3]};if(l)return c.lineSegmentPlane(t,r,e,n),c.lineSegmentPlane(t,a,e,i),{positions:[a,t,r,n,i],indices:[1,3,4,2,0,4,2,4,3]};if(s)return c.lineSegmentPlane(r,a,e,n),c.lineSegmentPlane(r,t,e,i),{positions:[a,t,r,n,i],indices:[2,3,4,0,1,4,0,4,3]}}else if(2==o){if(!u)return c.lineSegmentPlane(t,a,e,n),c.lineSegmentPlane(r,a,e,i),{positions:[a,t,r,n,i],indices:[1,2,4,1,4,3,0,3,4]};if(!l)return c.lineSegmentPlane(r,t,e,n),c.lineSegmentPlane(a,t,e,i),{positions:[a,t,r,n,i],indices:[2,0,4,2,4,3,1,3,4]};if(!s)return c.lineSegmentPlane(a,r,e,n),c.lineSegmentPlane(t,r,e,i),{positions:[a,t,r,n,i],indices:[0,1,4,0,4,3,2,3,4]}}},a.IntersectionTests=c,a.Ray=r});
